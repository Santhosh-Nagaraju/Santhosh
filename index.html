<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAG Chatbot</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Blinking dots for bot typing */
  @keyframes blink {
    0%, 80%, 100% { opacity: 0 }
    40% { opacity: 1 }
  }
  .dot {
    display: inline-block;
    margin: 0 2px;
    width: 6px;
    height: 6px;
    background-color: currentColor;
    border-radius: 50%;
    animation: blink 1.4s infinite both;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen transition-colors">

<div id="container" class="bg-white dark:bg-gray-800 w-full max-w-md h-[80vh] flex flex-col shadow-lg rounded-xl overflow-hidden">
  
  <header class="flex justify-between items-center bg-indigo-600 dark:bg-indigo-700 text-white px-4 py-3 font-bold text-lg">
    RAG Chatbot
    <div class="flex gap-2">
      <button id="themeToggle" class="bg-white dark:bg-gray-900 text-indigo-600 dark:text-indigo-300 px-2 py-1 rounded">ðŸŒ™</button>
      <button id="clearChat" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">Clear</button>
    </div>
  </header>

  <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50 dark:bg-gray-900"></div>

  <div class="flex p-2 bg-gray-100 dark:bg-gray-800 border-t border-gray-300 dark:border-gray-700">
    <input id="query" type="text" placeholder="Type your message..." class="flex-1 border border-gray-300 dark:border-gray-600 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white" />
    <button id="sendBtn" class="ml-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full">Send</button>
  </div>

</div>

<script>
const chat = document.getElementById('chat');
const queryInput = document.getElementById('query');
const sendBtn = document.getElementById('sendBtn');
const themeToggle = document.getElementById('themeToggle');
const clearChatBtn = document.getElementById('clearChat');
const WEBHOOK_URL = "https://santhoshnagaraju.app.n8n.cloud/webhook/rag-chat";

// Load chat history
let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
chatHistory.forEach(msg => addMessage(msg.text, msg.sender));

// Theme toggle
themeToggle.addEventListener('click', ()=>{
  document.documentElement.classList.toggle('dark');
  themeToggle.textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
});

// Clear chat functionality
clearChatBtn.addEventListener('click', ()=>{
  chat.innerHTML = '';
  chatHistory = [];
  localStorage.removeItem('chatHistory');
});

// Save message to history
function saveMessage(text, sender){
  chatHistory.push({text, sender});
  localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
}

// Add message to chat
function addMessage(text, sender){
  const div = document.createElement('div');
  div.className = `max-w-[80%] px-4 py-2 rounded-2xl break-words ${sender==='user'?'bg-indigo-600 text-white self-end':'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 self-start'}`;
  div.textContent = text;
  div.style.alignSelf = sender==='user'?'flex-end':'flex-start';
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  saveMessage(text, sender);
}

// Send message to webhook
async function sendMessage(){
  const question = queryInput.value.trim();
  if(!question) return;

  addMessage(question, 'user');
  queryInput.value = '';
  sendBtn.disabled = true;

  // Bot thinking indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'max-w-[80%] px-4 py-2 rounded-2xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 self-start flex items-center';
  for(let i=0;i<3;i++){
    const dot = document.createElement('span');
    dot.className = 'dot';
    loadingDiv.appendChild(dot);
  }
  chat.appendChild(loadingDiv);
  chat.scrollTop = chat.scrollHeight;

  try{
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: question})
    });
    const data = await res.json();
    loadingDiv.innerHTML = '';
    const answer = data.answer || 'No response';

    // Typing animation
    for(let i=0;i<answer.length;i++){
      loadingDiv.textContent += answer[i];
      await new Promise(r=>setTimeout(r, 15));
      chat.scrollTop = chat.scrollHeight;
    }
    saveMessage(answer, 'bot');

  }catch(err){
    console.error(err);
    loadingDiv.textContent = 'Failed to get response.';
    saveMessage('Failed to get response.', 'bot');
  }finally{
    sendBtn.disabled = false;
    queryInput.focus();
  }
}

// Send message via button click or Enter key
sendBtn.addEventListener('click', sendMessage);
queryInput.addEventListener('keypress', (e)=>{if(e.key==='Enter') sendMessage();});
</script>

</body>
</html>
